#!/usr/bin/env sh

set -e

for var in $(env | grep 'php_'); do
  var1=$(echo "$var" | sed 's/php_//g')
  echo "$var1" >> /usr/local/etc/php/php.ini
done

# Fix permissions on private storage
if [ -d "/data/private" ]; then
  chown -R www-data:www-data /data/private
fi

# Fix permissions on public storage for multisite installations
if [ -d "/usr/share/nginx/html/web/sites" ]; then
  find /usr/share/nginx/html/web/sites/ -name files -exec chown -R www-data:www-data {} \+
fi

if [[ "${CRON_SCHEDULE_COMMAND}" ]] && [[ ! -f /var/run/cron.installed ]]; then
  echo "Installing custom CRON job in /etc/crontabs/root"
  echo "${CRON_SCHEDULE_COMMAND}" | envsubst | sed -e 's/^"//g;s/"$//g' >> /etc/crontabs/root
  ln -s /etc/crontabs/root /var/run/cron.installed
fi

supervisord --nodaemon --configuration /etc/supervisord.conf